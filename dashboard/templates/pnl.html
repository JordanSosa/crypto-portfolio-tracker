{% extends "layout.html" %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Net PnL Card -->
    <div class="glass-card p-6 rounded-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-10">
            <i class="fas fa-chart-line text-6xl text-white"></i>
        </div>
        <h3 class="text-gray-400 text-sm font-medium mb-1">Net P&L (All Time)</h3>
        {% if summary and not error %}
        <div
            class="text-3xl font-bold mb-1 {% if summary.total_gain_loss >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            {{ "AU$" if summary.total_gain_loss is not none else "" }}{{ "{:,.2f}".format(summary.total_gain_loss) if
            summary.total_gain_loss is not none else "N/A" }}
        </div>
        <div class="text-sm {% if summary.total_return_pct >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            <i class="fas fa-{{ 'arrow-up' if summary.total_return_pct >= 0 else 'arrow-down' }} mr-1"></i>
            {{ "{:,.2f}".format(summary.total_return_pct) }}% Return on Cost
        </div>
        {% else %}
        <div class="text-3xl font-bold text-gray-500">--</div>
        <div class="text-sm text-gray-500">No Data</div>
        {% endif %}
    </div>

    <!-- Unrealized PnL Card -->
    <div class="glass-card p-6 rounded-2xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Unrealized Gains</h3>
        {% if summary and not error %}
        <div
            class="text-2xl font-bold mb-1 {% if summary.total_unrealized_gain_loss >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            {{ "AU$" if summary.total_unrealized_gain_loss is not none else "" }}{{
            "{:,.2f}".format(summary.total_unrealized_gain_loss) }}
        </div>
        <div class="text-xs text-gray-400">held in assets</div>
        {% else %}
        <div class="text-2xl font-bold text-gray-500">--</div>
        {% endif %}
    </div>

    <!-- Realized PnL Card -->
    <div class="glass-card p-6 rounded-2xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Realized Gains</h3>
        {% if summary and not error %}
        <div
            class="text-2xl font-bold mb-1 {% if summary.total_realized_gain_loss >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            {{ "AU$" if summary.total_realized_gain_loss is not none else "" }}{{
            "{:,.2f}".format(summary.total_realized_gain_loss) }}
        </div>
        <div class="text-xs text-gray-400">from sales</div>
        {% else %}
        <div class="text-2xl font-bold text-gray-500">--</div>
        {% endif %}
    </div>

    <!-- Cost Basis Card -->
    <div class="glass-card p-6 rounded-2xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Total Cost Basis</h3>
        {% if summary and not error %}
        <div class="text-2xl font-bold text-white mb-1">
            AU${{ "{:,.2f}".format(summary.total_cost_basis) }}
        </div>
        <div class="text-xs text-gray-400">invested capital</div>
        {% else %}
        <div class="text-2xl font-bold text-gray-500">--</div>
        {% endif %}
    </div>
</div>

<!-- Warning if prices failed or no data -->
{% if error %}
<div class="glass-card p-6 rounded-2xl mb-8 border border-red-500/30 bg-red-500/10">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-400 text-xl mr-3"></i>
        <div>
            <h3 class="text-lg font-bold text-red-400">PnL Data Unavailable</h3>
            <p class="text-gray-300 text-sm">{{ error }}</p>
        </div>
    </div>
</div>
{% elif summary.prices_failed %}
<div class="glass-card p-6 rounded-2xl mb-8 border border-yellow-500/30 bg-yellow-500/10">
    <div class="flex items-center">
        <i class="fas fa-exclamation-circle text-yellow-400 text-xl mr-3"></i>
        <div>
            <h3 class="text-lg font-bold text-yellow-400">Price Data Incomplete</h3>
            <p class="text-gray-300 text-sm">Could not fetch current prices for some assets. Unrealized gains may be
                inaccurate.</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed PnL Table -->
<div class="glass-card rounded-2xl overflow-hidden">
    <div class="p-6 border-b border-white/5 flex justify-between items-center">
        <h2 class="text-xl font-bold">Asset Performance</h2>
        <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">FIFO Accounting</span>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-black/20 text-gray-400 text-xs uppercase">
                <tr>
                    <th class="px-6 py-4 text-left font-medium">Asset</th>
                    <th class="px-6 py-4 text-right font-medium">Holdings</th>
                    <th class="px-6 py-4 text-right font-medium">Avg Cost</th>
                    <th class="px-6 py-4 text-right font-medium">Current Price</th>
                    <th class="px-6 py-4 text-right font-medium">Cost Basis</th>
                    <th class="px-6 py-4 text-right font-medium">Current Value</th>
                    <th class="px-6 py-4 text-right font-medium">Unrealized P&L</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5 text-sm">
                {% if summary and summary.unrealized_pnl %}
                {% for symbol, pnl in summary.unrealized_pnl.items() %}
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 font-medium text-white flex items-center">
                        <div
                            class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center mr-3 text-indigo-400 font-bold text-xs">
                            {{ symbol[:2] }}
                        </div>
                        {{ symbol }}
                    </td>
                    <td class="px-6 py-4 text-right text-gray-300">
                        {{ "{:,.6f}".format(pnl.current_amount) }}
                    </td>
                    <td class="px-6 py-4 text-right text-gray-300">
                        AU${{ "{:,.2f}".format(pnl.average_cost_basis) }}
                    </td>
                    <td class="px-6 py-4 text-right text-gray-300">
                        AU${{ "{:,.2f}".format(pnl.current_price) }}
                    </td>
                    <td class="px-6 py-4 text-right text-gray-300">
                        AU${{ "{:,.2f}".format(pnl.total_cost_basis) }}
                    </td>
                    <td class="px-6 py-4 text-right font-medium text-white">
                        AU${{ "{:,.2f}".format(pnl.current_value) }}
                    </td>
                    <td
                        class="px-6 py-4 text-right font-bold {% if pnl.unrealized_gain_loss >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                        {{ "+" if pnl.unrealized_gain_loss > 0 else "" }}AU${{
                        "{:,.2f}".format(pnl.unrealized_gain_loss) }}
                        <span class="text-xs font-normal ml-1 opacity-75">({{
                            "{:,.2f}".format(pnl.unrealized_gain_loss_pct) }}%)</span>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500 italic">
                        No P&L data available. Import transactions or verify cost basis data.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}